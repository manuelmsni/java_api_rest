<!DOCTYPE html>
<html>
    <head>
        <title>/api-1.0-SNAPSHOT</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style type="text/css">
            body {
                margin: 0;
            }
            h1 {
                margin: 0;
            }
            a:hover {
                cursor: pointer;
            }
            #login, #register {
                display: none;
                margin: auto;
                z-index: 1000;
                position: absolute;
                justify-content: center;
                height: 100%;
                align-items: center;
                width: 100%;
                flex-direction: column;
                background-color: #000000c9;
            }
            #login form, #register form {
                display: flex;
                padding: 2rem;
                background-color: white;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset;
                border-radius: 15px;
                row-gap: 1rem;
                flex-direction: column;
            }
            #login div, #register div {
                display: flex;
                flex-direction: column;
            }
            #login button, #register button {
                margin-top: 0.5rem;
            }
            
        </style>
    </head>
    <body>
        <script>
            var baseURL = "http://localhost:6003/api-1.0-SNAPSHOT/api/";
            // Función para manejar el envío del formulario
            async function handleLogin(event) {
                event.preventDefault(); // Evita el envío estándar del formulario

                // Obtiene los valores de los campos del formulario
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                // Define los datos a enviar en formato JSON
                const data = {email: username, password: password};

                try {
                    // Realiza la solicitud a la API
                    const response = await fetch(baseURL + 'login', {
                        method: 'POST', // Método HTTP
                        headers: {
                            'Content-Type': 'application/json', // Indica el tipo de contenido que se está enviando
                        },
                        body: JSON.stringify(data), // Convierte los datos a una cadena JSON
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Procesa la respuesta JSON, que se espera contenga el JWT
                    const {jwt} = await response.json();

                    // Aquí puedes usar el JWT como necesites, por ejemplo, guardarlo en localStorage
                    console.log('JWT recibido:', jwt);
                    localStorage.setItem('jwt', jwt);

                    // Oculta el formulario de inicio de sesión después de un inicio de sesión exitoso
                    login(false);
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                    // Aquí puedes manejar errores de inicio de sesión, como mostrar mensajes al usuario
                }
            }
            async function fetchWithJWT(endpoint, method = 'GET', body = null) {
                var url = baseURL + endpoint;
                const jwt = localStorage.getItem('jwt'); // Obtiene el JWT almacenado

                // Verifica si el JWT existe
                if (!jwt) {
                    // Muestra el formulario de inicio de sesión si no existe un JWT
                    login(true);
                    throw new Error('No JWT found, showing login form.');
                }

                // Prepara las opciones de la solicitud
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${jwt}`, // Usa el JWT en la cabecera Authorization
                        'Content-Type': 'application/json',
                    },
                };

                // Añade el cuerpo a la solicitud si es necesario y no es una solicitud GET
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                try {
                    const response = await fetch(url, options);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Supone que la respuesta es JSON; ajusta según sea necesario
                    return await response.json();
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                    throw error; // O maneja el error según lo necesites
                }
            }
            async function fetchWithoutJWT(endpoint, method = 'GET', body = null) {
                var url = baseURL + endpoint;
                // Prepara las opciones de la solicitud
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                // Añade el cuerpo a la solicitud si es necesario y no es una solicitud GET
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                try {
                    const response = await fetch(url, options);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Supone que la respuesta es JSON; ajusta según sea necesario
                    return await response.json();
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                    throw error; // O maneja el error según lo necesites
                }
            }
            async function handleRegister(event) {
                event.preventDefault(); // Evita el envío estándar del formulario

                const username = document.getElementById('reg_username').value;
                const email = document.getElementById('reg_email').value;
                const password = document.getElementById('reg_password').value;
                const repeatPassword = document.getElementById('repeat_password').value;

                // Validación de las contraseñas ingresadas
                if (password !== repeatPassword) {
                    alert('Las contraseñas no coinciden.');
                    return; // Detiene la ejecución si las contraseñas no coinciden
                }

                const data = {username: username, email: email, password: password};

                try {
                    // Realiza la solicitud a la API
                    const response = await fetch(baseURL + 'register', {
                        method: 'POST', // Método HTTP
                        headers: {
                            'Content-Type': 'application/json', // Indica el tipo de contenido que se está enviando
                        },
                        body: JSON.stringify(data), // Convierte los datos a una cadena JSON
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Procesa la respuesta JSON, que se espera contenga algún tipo de confirmación o el JWT directamente
                    const responseData = await response.json();

                    // Aquí puedes manejar la respuesta de la API, por ejemplo, mostrando un mensaje de éxito o redireccionando al usuario
                    console.log('Registro exitoso:', responseData);
                    // Opcional: redireccionar al usuario o mostrar un mensaje de éxito
                    alert('Registro exitoso. Por favor, inicia sesión.');

                    // Oculta el formulario de registro y muestra el de inicio de sesión
                    login(true);
                    register(false);
                } catch (error) {
                    console.error('Error al realizar la solicitud de registro:', error);
                    // Aquí puedes manejar errores de registro, como mostrar mensajes al usuario
                    alert('Error en el registro. Por favor, intenta de nuevo.');
                }
            }
            function register(bool){
                if(bool){
                    document.getElementById('register').style.display = 'flex';
                } else {
                    document.getElementById('register').style.display = 'none';
                }
            }
            function login(bool){
                if(bool){
                    document.getElementById('login').style.display = 'flex';
                } else {
                    document.getElementById('login').style.display = 'none';
                }
            }
            async function load() {
                // Intenta obtener el JWT del localStorage
                const jwt = localStorage.getItem('jwt');

                // Verifica si el JWT no existe o está vacío
                if (!jwt) {
                    // Muestra el formulario de inicio de sesión si no hay JWT
                    login(true);
                } else {
                    // Si el JWT existe, verifica su validez con el servidor
                    try {
                        const response = await fetch(baseURL + 'session', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jwt}`, // Usa el JWT en la cabecera Authorization
                            },
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        login(false);
                    } catch (error) {
                        console.error('Error al verificar el token:', error);
                        login(true);
                    }
                }
            }
            document.addEventListener('DOMContentLoaded', function() {
                load();
            });
        </script>
       
        <div id="login">
            <form onsubmit="handleLogin(event)">
                <div>
                    <label for="username">Correo electrónico:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div>
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div>
                    <button type="submit">Iniciar Sesión</button>
                </div>
                <div>
                    <a onclick="register(true),login(false)">Registrarse</a>
                </div>
            </form>
        </div>
        <div id="register">
            <form onsubmit="handleRegister(event)">
                <div>
                    <label for="reg_username">Nombre de usuario:</label>
                    <input type="text" id="reg_username" name="username" required>
                </div>
                <div>
                    <label for="reg_email">Correo electrónico:</label>
                    <input type="email" id="reg_email" name="email" required>
                </div>
                <div>
                    <label for="reg_password">Contraseña:</label>
                    <input type="password" id="reg_password" name="password" required>
                </div>
                <div>
                    <label for="repeat_password">Repetir Contraseña:</label>
                    <input type="password" id="repeat_password" name="repeatPassword" required>
                </div>
                <div>
                    <button type="submit">Registrarse</button>
                </div>
                <div>
                    <a onclick="login(true),register(false)">Iniciar Sesión</a>
                </div>
            </form>
        </div>
        <h1>Documentación</h1>
        <p>Turorial de creación del proyecto: <a href="https://www.youtube.com/watch?v=r_CGbP9kYbc">[Enlace]</a></p>
        <p>Comando crear imagen docker: docker build -t api-1.0-snapshot .</p>
        <p></p>
    </body>
</html>
