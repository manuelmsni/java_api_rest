<!DOCTYPE html>
<html>
    <head>
        <title>/api-1.0-SNAPSHOT</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style type="text/css">
            :root{
                --main-width: 1100px;
            }
            body {
                margin: 0;
                font-family: system-ui;
            }
            h1, h2 {
                margin: 0;
            }
            a{
                text-decoration: underline;
                color: cadetblue;
            }
            a:hover {
                cursor: pointer;
                color: darkcyan;
            }
            #login, #register {
                display: none;
                margin: auto;
                z-index: 1000;
                position: absolute;
                top: 0;
                left: 0;
                justify-content: center;
                height: 100%;
                align-items: center;
                width: 100%;
                flex-direction: column;
                background-color: #363636;
            }
            #login form, #register form {
                display: flex;
                padding: 2rem;
                background-color: white;
                row-gap: 1rem;
                flex-direction: column;
            }
            #login div, #register div {
                display: flex;
                flex-direction: column;
            }
            #login button, #register button {
                margin-top: 0.5rem;
            }
            .border{
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset;
                border-radius: 15px;
            }
            .container{
                max-width: var(--main-width);
                margin: auto;
                margin-top: 1rem;
                margin-bottom: 1rem;
                box-sizing: border-box;
                overflow: hidden;
            }
            .inline-list {
                list-style: none;
            }
            .inline-list li{
                display: inline;
            }
            @media screen and (max-width: calc(1100px + 2rem)) {
                .container{
                    margin-left: 1rem;
                    margin-right: 1rem;
                }
            }
            
        </style>
    </head>
    <body>
        <script>
            var baseURL = "http://localhost:6003/api-1.0-SNAPSHOT/api/";
            async function handleLogin(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const data = {email: username, password: password};
                try {
                    const response = await fetch(baseURL + 'login', {
                        method: 'POST', // Método HTTP
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const {jwt} = await response.json();
                    console.log('JWT recibido:', jwt);
                    localStorage.setItem('jwt', jwt);
                    getUserData();
                    login(false);
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                }
            }
            async function fetchWithJWT(endpoint, method = 'GET', body = null) {
                var url = baseURL + endpoint;
                const jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    login(true);
                    throw new Error('No JWT found, showing login form.');
                }
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${jwt}`,
                        'Content-Type': 'application/json',
                    },
                };
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                    throw error;
                }
            }
            async function fetchWithoutJWT(endpoint, method = 'GET', body = null) {
                var url = baseURL + endpoint;
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error al realizar la solicitud:', error);
                    throw error;
                }
            }
            async function handleRegister(event) {
                event.preventDefault(); 
                const username = document.getElementById('reg_username').value;
                const email = document.getElementById('reg_email').value;
                const password = document.getElementById('reg_password').value;
                const repeatPassword = document.getElementById('repeat_password').value;
                if (password !== repeatPassword) {
                    alert('Las contraseñas no coinciden.');
                    return;
                }
                const data = {username: username, email: email, password: password};
                try {
                    const response = await fetch(baseURL + 'register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', 
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    console.log('Registro exitoso:', responseData);
                    login(true);
                    register(false);
                } catch (error) {
                    console.error('Error al realizar la solicitud de registro:', error);
                    alert('Error en el registro. Por favor, intenta de nuevo.');
                }
            }
            function register(bool){
                if(bool){
                    document.getElementById('register').style.display = 'flex';
                } else {
                    document.getElementById('register').style.display = 'none';
                    document.getElementById('reg_password').value = "";
                    document.getElementById('repeat_password').value = "";
                }
            }
            function login(bool){
                if(bool){
                    document.getElementById('login').style.display = 'flex';
                } else {
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('password').value = "";
                }
            }
            async function load() {
                const jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    login(true);
                } else {
                    try {
                        const response = await fetch(baseURL + 'session', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jwt}`,
                            },
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        getUserData();
                        login(false);
                    } catch (error) {
                        console.error('Error al verificar el token:', error);
                        login(true);
                    }
                }
            }
            async function getUserData(){
                try {
                    var userData = await fetchWithJWT("user");
                    document.getElementById('displayUsername').textContent = userData.username;
                } catch (error) {
                    console.error('Error al obtener los datos del usuario:', error);
                }
            }
            function logout() {
                localStorage.removeItem('jwt');
                login(true);
                register(false);
                document.getElementById('displayUsername').textContent = '';
            }
            document.addEventListener('DOMContentLoaded', function() {
                load();
            });
        </script>
       
        <div id="login">
            <form onsubmit="handleLogin(event)" class="border">
                <h2>Login</h2>
                <div>
                    <label for="username">Correo electrónico:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div>
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div>
                    <button type="submit">Iniciar Sesión</button>
                </div>
                <div>
                    <a onclick="register(true),login(false)">Registrarse</a>
                </div>
            </form>
        </div>
        <div id="register">
            <form onsubmit="handleRegister(event)" class="border">
                <h2>Register</h2>
                <div>
                    <label for="reg_username">Nombre de usuario:</label>
                    <input type="text" id="reg_username" name="username" required>
                </div>
                <div>
                    <label for="reg_email">Correo electrónico:</label>
                    <input type="email" id="reg_email" name="email" required>
                </div>
                <div>
                    <label for="reg_password">Contraseña:</label>
                    <input type="password" id="reg_password" name="password" required>
                </div>
                <div>
                    <label for="repeat_password">Repetir Contraseña:</label>
                    <input type="password" id="repeat_password" name="repeatPassword" required>
                </div>
                <div>
                    <button type="submit">Registrarse</button>
                </div>
                <div>
                    <a onclick="login(true),register(false)">Iniciar Sesión</a>
                </div>
            </form>
        </div>
        <div class="container border">
            <ul class="inline-list">
                <li id="displayUsername"></li>
                <li><a onclick="logout()">Cerrar sesión</a></li>
            </ul>
        </div>
    </body>
</html>
